<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ–‡å­—éŠæˆ²</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #162447;
        }
        
        h1 {
            color: #4cc9f0;
            margin-bottom: 20px;
        }
        
        .config-section {
            background-color: #162447;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #a9b7c6;
            font-weight: bold;
        }
        
        input[type="text"], input[type="password"], input[type="file"] {
            width: 100%;
            padding: 10px;
            background-color: #0f3460;
            border: 1px solid #2d4059;
            border-radius: 5px;
            color: #e6e6e6;
            font-size: 16px;
        }
        
        button {
            background-color: #4cc9f0;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-top: 5px;
        }
        
        button:hover {
            background-color: #3aa8d8;
        }
        
        button:disabled {
            background-color: #2d4059;
            color: #7a7a7a;
            cursor: not-allowed;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            background-color: #162447;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background-color: #0f3460;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            background-color: #162447;
            border-bottom: 3px solid #4cc9f0;
            color: #4cc9f0;
        }
        
        .tab-content {
            display: none;
            background-color: #162447;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            min-height: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            background-color: #0f3460;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .status-item {
            margin: 5px 10px;
        }
        
        .game-scene {
            position: relative;
            width: 100%;
            height: 300px;
            background-color: #0a1931;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .background-image, .character-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .character-image {
            object-fit: contain;
            height: 90%;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .story-text {
            background-color: #0f3460;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .option-btn {
            padding: 15px;
            background-color: #2d4059;
            border: none;
            border-radius: 8px;
            color: #e6e6e6;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.3s;
        }
        
        .option-btn:hover {
            background-color: #3a506b;
        }
        
        .custom-action {
            display: flex;
            margin-bottom: 20px;
        }
        
        .custom-action input {
            flex: 1;
            margin-right: 10px;
        }
        
        .data-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .data-card {
            background-color: #0f3460;
            padding: 20px;
            border-radius: 10px;
        }
        
        .event-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .event-item {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .event-title {
            color: #4cc9f0;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .save-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .save-btn {
            padding: 15px 40px;
            font-size: 18px;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .success {
            background-color: #2e8b57;
            color: white;
        }
        
        .error {
            background-color: #b22222;
            color: white;
        }
        
        .loading {
            color: #4cc9f0;
            text-align: center;
            padding: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .debug-panel {
            background-color: #0a1931;
            border: 1px solid #2d4059;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-title {
            color: #4cc9f0;
            font-weight: bold;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .debug-content {
            color: #a9b7c6;
        }
        
        .api-key-display {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .api-key-display span {
            color: #4cc9f0;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .data-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="game-title">AIæ–‡å­—éŠæˆ²</h1>
    </header>
    
    <div class="config-section">
        <div class="input-group">
            <label for="title-input">éŠæˆ²æ¨™é¡Œï¼š</label>
            <input type="text" id="title-input" placeholder="è¼¸å…¥éŠæˆ²æ¨™é¡Œ" value="AIæ–‡å­—éŠæˆ²">
        </div>
        
        <div class="input-group">
            <label for="api-key">Gemini API keyï¼š</label>
            <input type="password" id="api-key" placeholder="è¼¸å…¥æ‚¨çš„Gemini APIé‡‘é‘°">
            <button id="test-api-btn">æ¸¬è©¦APIé€£æ¥</button>
            <button id="show-api-key" title="é¡¯ç¤º/éš±è—APIé‡‘é‘°">ğŸ‘ï¸</button>
            <span id="api-status" class="status-indicator hidden"></span>
            <div id="api-key-info" class="api-key-display hidden">
                ç•¶å‰APIé‡‘é‘°: <span id="api-key-preview"></span>
            </div>
        </div>
        
        <div class="input-group">
            <label for="character-data">äººç‰©è³‡æ–™ï¼š</label>
            <input type="file" id="character-data" accept=".txt">
            <span id="character-status" class="status-indicator hidden"></span>
        </div>
        
        <div class="input-group">
            <label for="background-library">èƒŒæ™¯åº«ï¼š</label>
            <input type="file" id="background-library" webkitdirectory directory multiple>
            <span id="background-status" class="status-indicator hidden"></span>
        </div>
        
        <div class="input-group">
            <label for="character-library">ç«‹ç¹ªåº«ï¼š</label>
            <input type="file" id="character-library" webkitdirectory directory multiple>
            <span id="character-library-status" class="status-indicator hidden"></span>
        </div>
        
        <div class="input-group">
            <label for="load-game">è®€æª”ï¼š</label>
            <input type="file" id="load-game" accept=".json">
            <span id="load-status" class="status-indicator hidden"></span>
        </div>
        
        <div class="debug-panel">
            <div class="debug-title" onclick="toggleDebug()">ğŸ” èª¿è©¦è³‡è¨Š (é»æ“Šå±•é–‹/æ”¶èµ·)</div>
            <div class="debug-content" id="debug-content">
                <div id="debug-log">ç­‰å¾…èª¿è©¦è³‡è¨Š...</div>
            </div>
        </div>
    </div>
    
    <div class="tab-container">
        <div class="tab active" data-tab="story">åŠ‡æƒ…</div>
        <div class="tab" data-tab="data">è³‡æ–™</div>
        <div class="tab" data-tab="events">äº‹ä»¶</div>
        <div class="tab" data-tab="save">å­˜æª”</div>
    </div>
    
    <div id="story-tab" class="tab-content active">
        <div class="status-bar">
            <div class="status-item">æ—¥æœŸï¼š<span id="current-date">2023å¹´10æœˆ15æ—¥</span></div>
            <div class="status-item">å¤©æ°£ï¼š<span id="current-weather">æ™´æœ—</span></div>
            <div class="status-item">åœ°é»ï¼š<span id="current-location">èµ·å§‹ä¹‹æ‘</span></div>
            <div class="status-item">äººç‰©ç‹€æ…‹ï¼š<span id="character-condition">æ­£å¸¸</span></div>
        </div>
        
        <div class="game-scene">
            <img id="background-image" class="background-image" src="" alt="èƒŒæ™¯">
            <img id="character-image" class="character-image" src="" alt="ç«‹ç¹ª">
        </div>
        
        <div class="story-text" id="story-text">
            <p>æ­¡è¿ä¾†åˆ°AIæ–‡å­—éŠæˆ²ï¼è«‹å…ˆè¨­å®šAPIé‡‘é‘°å’Œè¼‰å…¥å¿…è¦è³‡æ–™ï¼Œç„¶å¾Œé–‹å§‹éŠæˆ²ã€‚</p>
        </div>
        
        <div class="options-container" id="options-container">
            <!-- é¸é …å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
        
        <div class="custom-action">
            <input type="text" id="custom-action-input" placeholder="è¼¸å…¥è‡ªå®šç¾©è¡Œå‹•...">
            <button id="submit-custom-action">ç¢ºèª</button>
        </div>
    </div>
    
    <div id="data-tab" class="tab-content">
        <h2>äººç‰©è³‡æ–™</h2>
        <div class="data-section">
            <div class="data-card">
                <h3>åŸºæœ¬è³‡æ–™</h3>
                <div id="character-basic-data">
                    <p>å§“åï¼š<span id="char-name">æœªè¼‰å…¥</span></p>
                    <p>å¹´é½¡ï¼š<span id="char-age">æœªè¼‰å…¥</span></p>
                    <p>æ€§æ ¼ï¼š<span id="char-personality">æœªè¼‰å…¥</span></p>
                    <p>ç°¡ä»‹ï¼š<span id="char-description">æœªè¼‰å…¥</span></p>
                </div>
            </div>
            
            <div class="data-card">
                <h3>äººç‰©ç‹€æ…‹</h3>
                <div id="character-status-data">
                    <p>å¥½æ„Ÿåº¦ï¼š<span id="char-favor">50</span></p>
                    <p>å¿ƒæƒ…ï¼š<span id="char-mood">æ™®é€š</span></p>
                    <p>é«”åŠ›ï¼š<span id="char-energy">80</span></p>
                    <p>ç²¾ç¥ï¼š<span id="char-spirit">70</span></p>
                    <p>å…§å¿ƒæƒ³æ³•ï¼š<span id="char-thoughts">...</span></p>
                </div>
            </div>
            
            <div class="data-card">
                <h3>ç©å®¶è³‡æ–™</h3>
                <div id="player-data">
                    <p>ç©å®¶åç¨±ï¼š<input type="text" id="player-name" placeholder="è¼¸å…¥ç©å®¶åç¨±"></p>
                    <p>è§’è‰²è¨­å®šï¼š<textarea id="player-setting" placeholder="è¼¸å…¥ç©å®¶åœ¨åŠ‡æƒ…ä¸­çš„è¨­å®š" rows="4"></textarea></p>
                    <button id="save-player-data">å„²å­˜ç©å®¶è³‡æ–™</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="events-tab" class="tab-content">
        <h2>äº‹ä»¶è¨˜éŒ„</h2>
        <div class="event-list" id="event-list">
            <!-- äº‹ä»¶å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
            <div class="event-item">
                <div class="event-title">éŠæˆ²é–‹å§‹</div>
                <p>æ­¡è¿ä¾†åˆ°AIæ–‡å­—éŠæˆ²ï¼ç³»çµ±å·²åˆå§‹åŒ–ï¼Œç­‰å¾…ç©å®¶é–‹å§‹éŠæˆ²ã€‚</p>
            </div>
        </div>
    </div>
    
    <div id="save-tab" class="tab-content">
        <div class="save-section">
            <h2>éŠæˆ²å­˜æª”</h2>
            <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å„²å­˜ç›®å‰çš„éŠæˆ²é€²åº¦</p>
            <button class="save-btn" id="save-game-btn">å„²å­˜éŠæˆ²</button>
            <div id="save-status" class="status-indicator hidden" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // éŠæˆ²ç‹€æ…‹è®Šæ•¸
        let gameState = {
            title: "AIæ–‡å­—éŠæˆ²",
            apiKey: "",
            apiConnected: false,
            date: { year: 2023, month: 10, day: 15 },
            weather: "æ™´æœ—",
            location: "èµ·å§‹ä¹‹æ‘",
            characterCondition: "æ­£å¸¸",
            backgroundImages: [],
            characterImages: [],
            characterData: null,
            playerData: {
                name: "",
                setting: ""
            },
            characterStatus: {
                favor: 50,
                mood: "æ™®é€š",
                energy: 80,
                spirit: 70,
                thoughts: "ç­‰å¾…éŠæˆ²é–‹å§‹..."
            },
            story: "æ­¡è¿ä¾†åˆ°AIæ–‡å­—éŠæˆ²ï¼è«‹å…ˆè¨­å®šAPIé‡‘é‘°å’Œè¼‰å…¥å¿…è¦è³‡æ–™ï¼Œç„¶å¾Œé–‹å§‹éŠæˆ²ã€‚",
            options: ["é–‹å§‹éŠæˆ²", "è¼‰å…¥ç¯„ä¾‹è³‡æ–™", "æŸ¥çœ‹æ•™å­¸", "é—œæ–¼éŠæˆ²"],
            events: [
                {
                    title: "éŠæˆ²é–‹å§‹",
                    content: "æ­¡è¿ä¾†åˆ°AIæ–‡å­—éŠæˆ²ï¼ç³»çµ±å·²åˆå§‹åŒ–ï¼Œç­‰å¾…ç©å®¶é–‹å§‹éŠæˆ²ã€‚",
                    timestamp: "2023-10-15 10:00:00"
                }
            ],
            currentBackground: "",
            currentCharacterImage: ""
        };

        // DOMå…ƒç´ 
        const titleInput = document.getElementById('title-input');
        const apiKeyInput = document.getElementById('api-key');
        const testApiBtn = document.getElementById('test-api-btn');
        const showApiKeyBtn = document.getElementById('show-api-key');
        const apiStatus = document.getElementById('api-status');
        const apiKeyInfo = document.getElementById('api-key-info');
        const apiKeyPreview = document.getElementById('api-key-preview');
        const characterDataInput = document.getElementById('character-data');
        const characterStatus = document.getElementById('character-status');
        const backgroundLibraryInput = document.getElementById('background-library');
        const backgroundStatus = document.getElementById('background-status');
        const characterLibraryInput = document.getElementById('character-library');
        const characterLibraryStatus = document.getElementById('character-library-status');
        const loadGameInput = document.getElementById('load-game');
        const loadStatus = document.getElementById('load-status');
        const debugContent = document.getElementById('debug-content');
        const debugLog = document.getElementById('debug-log');
        
        // æ¨™ç±¤åˆ‡æ›
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // åŠ‡æƒ…é å…ƒç´ 
        const currentDate = document.getElementById('current-date');
        const currentWeather = document.getElementById('current-weather');
        const currentLocation = document.getElementById('current-location');
        const characterCondition = document.getElementById('character-condition');
        const backgroundImage = document.getElementById('background-image');
        const characterImage = document.getElementById('character-image');
        const storyText = document.getElementById('story-text');
        const optionsContainer = document.getElementById('options-container');
        const customActionInput = document.getElementById('custom-action-input');
        const submitCustomAction = document.getElementById('submit-custom-action');
        
        // è³‡æ–™é å…ƒç´ 
        const charName = document.getElementById('char-name');
        const charAge = document.getElementById('char-age');
        const charPersonality = document.getElementById('char-personality');
        const charDescription = document.getElementById('char-description');
        const charFavor = document.getElementById('char-favor');
        const charMood = document.getElementById('char-mood');
        const charEnergy = document.getElementById('char-energy');
        const charSpirit = document.getElementById('char-spirit');
        const charThoughts = document.getElementById('char-thoughts');
        const playerName = document.getElementById('player-name');
        const playerSetting = document.getElementById('player-setting');
        const savePlayerDataBtn = document.getElementById('save-player-data');
        
        // äº‹ä»¶é å…ƒç´ 
        const eventList = document.getElementById('event-list');
        
        // å­˜æª”é å…ƒç´ 
        const saveGameBtn = document.getElementById('save-game-btn');
        const saveStatus = document.getElementById('save-status');

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            logDebug("éŠæˆ²åˆå§‹åŒ–é–‹å§‹");
            
            // å¾localStorageè¼‰å…¥å·²å„²å­˜çš„APIé‡‘é‘°
            const savedApiKey = localStorage.getItem('gemini_api_key');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                gameState.apiKey = savedApiKey;
                logDebug(`å¾localStorageè¼‰å…¥APIé‡‘é‘°: ${savedApiKey.substring(0, 8)}...`);
            }
            
            // è¨­ç½®æ¨™é¡Œ
            titleInput.addEventListener('change', updateTitle);
            
            // APIæ¸¬è©¦
            testApiBtn.addEventListener('click', testApiConnection);
            
            // é¡¯ç¤º/éš±è—APIé‡‘é‘°
            showApiKeyBtn.addEventListener('click', toggleApiKeyVisibility);
            
            // æª”æ¡ˆè¼‰å…¥
            characterDataInput.addEventListener('change', loadCharacterData);
            backgroundLibraryInput.addEventListener('change', loadBackgroundLibrary);
            characterLibraryInput.addEventListener('change', loadCharacterLibrary);
            loadGameInput.addEventListener('change', loadGameFile);
            
            // æ¨™ç±¤åˆ‡æ›
            tabs.forEach(tab => {
                tab.addEventListener('click', switchTab);
            });
            
            // é¸é …é»æ“Š
            optionsContainer.addEventListener('click', handleOptionClick);
            
            // è‡ªå®šç¾©è¡Œå‹•
            submitCustomAction.addEventListener('click', handleCustomAction);
            
            // å„²å­˜ç©å®¶è³‡æ–™
            savePlayerDataBtn.addEventListener('click', savePlayerData);
            
            // å„²å­˜éŠæˆ²
            saveGameBtn.addEventListener('click', saveGame);
            
            // æ›´æ–°é¡¯ç¤º
            updateDisplay();
            
            // åˆå§‹åŒ–é¸é …
            generateOptions();
            
            logDebug("éŠæˆ²åˆå§‹åŒ–å®Œæˆ");
        }

        // æ›´æ–°éŠæˆ²æ¨™é¡Œ
        function updateTitle() {
            gameState.title = titleInput.value;
            document.getElementById('game-title').textContent = gameState.title;
            logDebug(`æ¨™é¡Œæ›´æ–°ç‚º: ${gameState.title}`);
        }

        // åˆ‡æ›APIé‡‘é‘°å¯è¦‹æ€§
        function toggleApiKeyVisibility() {
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                showApiKeyBtn.textContent = 'ğŸ™ˆ';
                showApiKeyBtn.title = 'éš±è—APIé‡‘é‘°';
            } else {
                apiKeyInput.type = 'password';
                showApiKeyBtn.textContent = 'ğŸ‘ï¸';
                showApiKeyBtn.title = 'é¡¯ç¤ºAPIé‡‘é‘°';
            }
        }

        // æ¸¬è©¦APIé€£æ¥
        async function testApiConnection() {
            const apiKey = apiKeyInput.value.trim();
            
            logDebug(`æ¸¬è©¦APIé€£æ¥ï¼Œè¼¸å…¥çš„APIé‡‘é‘°é•·åº¦: ${apiKey.length}`);
            
            if (!apiKey) {
                showStatus(apiStatus, "è«‹è¼¸å…¥APIé‡‘é‘°", "error");
                logDebug("APIé‡‘é‘°ç‚ºç©º");
                return;
            }
            
            // æª¢æŸ¥APIé‡‘é‘°æ ¼å¼
            if (!apiKey.startsWith('AIza')) {
                showStatus(apiStatus, "APIé‡‘é‘°æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ä»¥AIzaé–‹é ­", "error");
                logDebug(`APIé‡‘é‘°æ ¼å¼éŒ¯èª¤ï¼Œé–‹é ­: ${apiKey.substring(0, 4)}`);
                return;
            }
            
            gameState.apiKey = apiKey;
            
            // å„²å­˜åˆ°localStorage
            localStorage.setItem('gemini_api_key', apiKey);
            
            showStatus(apiStatus, "æ¸¬è©¦é€£æ¥ä¸­...", "loading");
            
            // æ›´æ–°APIé‡‘é‘°é¡¯ç¤º
            apiKeyPreview.textContent = `${apiKey.substring(0, 10)}...`;
            apiKeyInfo.classList.remove('hidden');
            
            logDebug(`APIé‡‘é‘°å·²å„²å­˜: ${apiKey.substring(0, 8)}...`);
            
            try {
                logDebug("é–‹å§‹å‘¼å«Gemini API...");
                
                // æ¸¬è©¦Gemini APIé€£æ¥
                const response = await callGeminiAPI("Hello", apiKey);
                
                logDebug(`APIå›æ‡‰ç‹€æ…‹: ${response ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                
                if (response && response.candidates && response.candidates.length > 0) {
                    const responseText = response.candidates[0].content.parts[0].text;
                    gameState.apiConnected = true;
                    showStatus(apiStatus, "é€£æ¥æˆåŠŸ", "success");
                    logDebug(`APIé€£æ¥æˆåŠŸï¼Œå›æ‡‰é•·åº¦: ${responseText.length} å­—å…ƒ`);
                    
                    // æ›´æ–°éŠæˆ²ç‹€æ…‹
                    gameState.story = "APIé€£æ¥æˆåŠŸï¼ç¾åœ¨å¯ä»¥é–‹å§‹éŠæˆ²äº†ã€‚";
                    gameState.options = ["é–‹å§‹å†’éšª", "æŸ¥çœ‹è§’è‰²è³‡æ–™", "æ¢ç´¢ä¸–ç•Œ", "è‡ªå®šç¾©è¡Œå‹•"];
                    updateDisplay();
                    generateOptions();
                    
                    // æ·»åŠ äº‹ä»¶è¨˜éŒ„
                    addEvent("APIé€£æ¥æˆåŠŸ", "æˆåŠŸé€£æ¥åˆ°Gemini APIï¼ŒéŠæˆ²åŠŸèƒ½å·²å•Ÿç”¨ã€‚");
                    
                    logDebug("éŠæˆ²ç‹€æ…‹å·²æ›´æ–°ï¼ŒAPIé€£æ¥æˆåŠŸ");
                } else {
                    throw new Error("APIå›æ‡‰ç„¡æ•ˆï¼Œæœªæ‰¾åˆ°candidates");
                }
            } catch (error) {
                console.error("APIé€£æ¥å¤±æ•—:", error);
                gameState.apiConnected = false;
                showStatus(apiStatus, "é€£æ¥å¤±æ•—", "error");
                showStatus(apiStatus, `é€£æ¥å¤±æ•—: ${error.message}`, "error");
                logDebug(`APIé€£æ¥å¤±æ•—: ${error.message}`);
            }
        }

        // å‘¼å«Gemini API
        async function callGeminiAPI(prompt, apiKey) {
            if (!apiKey) {
                logDebug("å‘¼å«APIå¤±æ•—: APIé‡‘é‘°ç‚ºç©º");
                throw new Error("APIé‡‘é‘°ç‚ºç©º");
            }
            
            logDebug(`å‘¼å«APIï¼Œæç¤ºè©é•·åº¦: ${prompt.length}ï¼ŒAPIé‡‘é‘°å‰8ä½: ${apiKey.substring(0, 8)}...`);
            
            // ä½¿ç”¨Gemini API
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
            
            const requestBody = {
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }]
            };
            
            logDebug(`API URL: ${apiUrl.substring(0, 50)}...`);
            logDebug(`è«‹æ±‚é«”: ${JSON.stringify(requestBody).substring(0, 100)}...`);
            
            try {
                const startTime = Date.now();
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const endTime = Date.now();
                logDebug(`APIè«‹æ±‚è€—æ™‚: ${endTime - startTime}ms`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    logDebug(`APIéŒ¯èª¤å›æ‡‰: ${response.status} - ${errorText.substring(0, 200)}`);
                    throw new Error(`APIéŒ¯èª¤: ${response.status} - ${errorText.substring(0, 100)}`);
                }
                
                const responseData = await response.json();
                logDebug(`APIæˆåŠŸå›æ‡‰ï¼Œè³‡æ–™é¡å‹: ${typeof responseData}`);
                
                return responseData;
            } catch (error) {
                logDebug(`å‘¼å«APIå¤±æ•—: ${error.message}`);
                throw error;
            }
        }

        // è¼‰å…¥äººç‰©è³‡æ–™
        function loadCharacterData(event) {
            const file = event.target.files[0];
            if (!file) {
                logDebug("æœªé¸æ“‡äººç‰©è³‡æ–™æª”æ¡ˆ");
                return;
            }
            
            logDebug(`è¼‰å…¥äººç‰©è³‡æ–™æª”æ¡ˆ: ${file.name}, å¤§å°: ${file.size} ä½å…ƒçµ„`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    logDebug(`äººç‰©è³‡æ–™æª”æ¡ˆå…§å®¹é•·åº¦: ${content.length} å­—å…ƒ`);
                    
                    // è§£æäººç‰©è³‡æ–™
                    const lines = content.split('\n');
                    const character = {};
                    
                    lines.forEach(line => {
                        const parts = line.split(':');
                        if (parts.length >= 2) {
                            const key = parts[0].trim();
                            const value = parts.slice(1).join(':').trim();
                            character[key] = value;
                            logDebug(`è§£æåˆ°äººç‰©è³‡æ–™: ${key} = ${value.substring(0, 30)}...`);
                        }
                    });
                    
                    gameState.characterData = character;
                    showStatus(characterStatus, "äººç‰©è³‡æ–™å·²æ›´æ–°", "success");
                    logDebug(`äººç‰©è³‡æ–™å·²è¼‰å…¥ï¼Œå…±æœ‰ ${Object.keys(character).length} å€‹å±¬æ€§`);
                    
                    // æ›´æ–°é¡¯ç¤º
                    if (character.å§“å) charName.textContent = character.å§“å;
                    if (character.å¹´é½¡) charAge.textContent = character.å¹´é½¡;
                    if (character.æ€§æ ¼) charPersonality.textContent = character.æ€§æ ¼;
                    if (character.ç°¡ä»‹) charDescription.textContent = character.ç°¡ä»‹;
                    
                    // æ·»åŠ äº‹ä»¶è¨˜éŒ„
                    addEvent("è¼‰å…¥äººç‰©è³‡æ–™", `å·²è¼‰å…¥äººç‰©è³‡æ–™: ${character.å§“å || "æœªçŸ¥äººç‰©"}`);
                    
                } catch (error) {
                    console.error("è®€å–äººç‰©è³‡æ–™å¤±æ•—:", error);
                    showStatus(characterStatus, "è®€å–å¤±æ•—", "error");
                    logDebug(`è®€å–äººç‰©è³‡æ–™å¤±æ•—: ${error.message}`);
                }
            };
            
            reader.onerror = function(e) {
                logDebug(`æª”æ¡ˆè®€å–éŒ¯èª¤: ${e.target.error}`);
                showStatus(characterStatus, "æª”æ¡ˆè®€å–éŒ¯èª¤", "error");
            };
            
            reader.readAsText(file);
        }

        // è¼‰å…¥èƒŒæ™¯åº«
        function loadBackgroundLibrary(event) {
            const files = event.target.files;
            if (!files || files.length === 0) {
                logDebug("æœªé¸æ“‡èƒŒæ™¯åº«æª”æ¡ˆ");
                return;
            }
            
            logDebug(`è¼‰å…¥èƒŒæ™¯åº«ï¼Œæª”æ¡ˆæ•¸é‡: ${files.length}`);
            
            gameState.backgroundImages = [];
            
            // éæ¿¾åœ–åƒæª”æ¡ˆ
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const url = URL.createObjectURL(file);
                    gameState.backgroundImages.push({
                        name: file.name,
                        url: url,
                        type: file.type,
                        size: file.size
                    });
                    logDebug(`è¼‰å…¥èƒŒæ™¯åœ–: ${file.name}, é¡å‹: ${file.type}, å¤§å°: ${file.size} ä½å…ƒçµ„`);
                }
            }
            
            if (gameState.backgroundImages.length > 0) {
                showStatus(backgroundStatus, `è®€å–æˆåŠŸ (${gameState.backgroundImages.length}å€‹èƒŒæ™¯)`, "success");
                logDebug(`èƒŒæ™¯åº«è¼‰å…¥æˆåŠŸï¼Œå…± ${gameState.backgroundImages.length} å€‹èƒŒæ™¯åœ–ç‰‡`);
                
                // è‡ªå‹•è¨­ç½®ç¬¬ä¸€å€‹èƒŒæ™¯
                if (gameState.backgroundImages.length > 0) {
                    gameState.currentBackground = gameState.backgroundImages[0].url;
                    backgroundImage.src = gameState.currentBackground;
                    logDebug(`è¨­ç½®ç•¶å‰èƒŒæ™¯: ${gameState.backgroundImages[0].name}`);
                }
                
                // æ·»åŠ äº‹ä»¶è¨˜éŒ„
                addEvent("è¼‰å…¥èƒŒæ™¯åº«", `å·²è¼‰å…¥${gameState.backgroundImages.length}å€‹èƒŒæ™¯åœ–ç‰‡`);
            } else {
                showStatus(backgroundStatus, "æœªæ‰¾åˆ°åœ–æª”", "error");
                logDebug("èƒŒæ™¯åº«ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ");
            }
        }

        // è¼‰å…¥ç«‹ç¹ªåº«
        function loadCharacterLibrary(event) {
            const files = event.target.files;
            if (!files || files.length === 0) {
                logDebug("æœªé¸æ“‡ç«‹ç¹ªåº«æª”æ¡ˆ");
                return;
            }
            
            logDebug(`è¼‰å…¥ç«‹ç¹ªåº«ï¼Œæª”æ¡ˆæ•¸é‡: ${files.length}`);
            
            gameState.characterImages = [];
            
            // éæ¿¾åœ–åƒæª”æ¡ˆ
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const url = URL.createObjectURL(file);
                    gameState.characterImages.push({
                        name: file.name,
                        url: url,
                        type: file.type,
                        size: file.size
                    });
                    logDebug(`è¼‰å…¥ç«‹ç¹ªåœ–: ${file.name}, é¡å‹: ${file.type}, å¤§å°: ${file.size} ä½å…ƒçµ„`);
                }
            }
            
            if (gameState.characterImages.length > 0) {
                showStatus(characterLibraryStatus, `è®€å–æˆåŠŸ (${gameState.characterImages.length}å€‹ç«‹ç¹ª)`, "success");
                logDebug(`ç«‹ç¹ªåº«è¼‰å…¥æˆåŠŸï¼Œå…± ${gameState.characterImages.length} å€‹ç«‹ç¹ªåœ–ç‰‡`);
                
                // è‡ªå‹•è¨­ç½®ç¬¬ä¸€å€‹ç«‹ç¹ª
                if (gameState.characterImages.length > 0) {
                    gameState.currentCharacterImage = gameState.characterImages[0].url;
                    characterImage.src = gameState.currentCharacterImage;
                    logDebug(`è¨­ç½®ç•¶å‰ç«‹ç¹ª: ${gameState.characterImages[0].name}`);
                }
                
                // æ·»åŠ äº‹ä»¶è¨˜éŒ„
                addEvent("è¼‰å…¥ç«‹ç¹ªåº«", `å·²è¼‰å…¥${gameState.characterImages.length}å€‹ç«‹ç¹ªåœ–ç‰‡`);
            } else {
                showStatus(characterLibraryStatus, "æœªæ‰¾åˆ°åœ–æª”", "error");
                logDebug("ç«‹ç¹ªåº«ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ");
            }
        }

        // è¼‰å…¥éŠæˆ²æª”æ¡ˆ
        function loadGameFile(event) {
            const file = event.target.files[0];
            if (!file) {
                logDebug("æœªé¸æ“‡éŠæˆ²å­˜æª”æª”æ¡ˆ");
                return;
            }
            
            logDebug(`è¼‰å…¥éŠæˆ²å­˜æª”: ${file.name}, å¤§å°: ${file.size} ä½å…ƒçµ„`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    logDebug(`éŠæˆ²å­˜æª”è§£ææˆåŠŸï¼Œæ¨™é¡Œ: ${data.title || 'ç„¡æ¨™é¡Œ'}`);
                    
                    // ç¢ºèªæ˜¯æœ‰æ•ˆçš„éŠæˆ²å­˜æª”
                    if (data.title && data.date) {
                        // è©¢å•ç”¨æˆ¶æ˜¯å¦è¼‰å…¥
                        if (confirm("æ˜¯å¦è¼‰å…¥æ­¤å­˜æª”ï¼Ÿé€™å°‡è¦†è“‹ç›®å‰çš„éŠæˆ²é€²åº¦ã€‚")) {
                            // è¼‰å…¥éŠæˆ²ç‹€æ…‹
                            Object.assign(gameState, data);
                            
                            // æ›´æ–°UI
                            updateDisplay();
                            generateOptions();
                            
                            showStatus(loadStatus, "è®€æª”æˆåŠŸ", "success");
                            logDebug("éŠæˆ²å­˜æª”è¼‰å…¥æˆåŠŸ");
                            
                            // æ·»åŠ äº‹ä»¶è¨˜éŒ„
                            addEvent("è¼‰å…¥éŠæˆ²å­˜æª”", `å·²è¼‰å…¥å­˜æª”: ${data.title}`);
                        }
                    } else {
                        throw new Error("ç„¡æ•ˆçš„å­˜æª”æ ¼å¼");
                    }
                } catch (error) {
                    console.error("è®€å–å­˜æª”å¤±æ•—:", error);
                    showStatus(loadStatus, "è®€å–å¤±æ•—", "error");
                    logDebug(`è®€å–å­˜æª”å¤±æ•—: ${error.message}`);
                }
            };
            
            reader.readAsText(file);
        }

        // åˆ‡æ›æ¨™ç±¤é 
        function switchTab(event) {
            const tabId = event.target.getAttribute('data-tab');
            logDebug(`åˆ‡æ›åˆ°æ¨™ç±¤é : ${tabId}`);
            
            // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°å…§å®¹é¡¯ç¤º
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            logDebug("æ›´æ–°éŠæˆ²é¡¯ç¤º");
            
            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('game-title').textContent = gameState.title;
            titleInput.value = gameState.title;
            
            // æ›´æ–°ç‹€æ…‹æ¬„
            currentDate.textContent = `${gameState.date.year}å¹´${gameState.date.month}æœˆ${gameState.date.day}æ—¥`;
            currentWeather.textContent = gameState.weather;
            currentLocation.textContent = gameState.location;
            characterCondition.textContent = gameState.characterCondition;
            
            // æ›´æ–°èƒŒæ™¯å’Œç«‹ç¹ª
            if (gameState.currentBackground) {
                backgroundImage.src = gameState.currentBackground;
                logDebug(`è¨­ç½®èƒŒæ™¯åœ–: ${gameState.currentBackground.substring(0, 50)}...`);
            } else {
                backgroundImage.src = "";
            }
            
            if (gameState.currentCharacterImage) {
                characterImage.src = gameState.currentCharacterImage;
                logDebug(`è¨­ç½®ç«‹ç¹ªåœ–: ${gameState.currentCharacterImage.substring(0, 50)}...`);
            } else {
                characterImage.src = "";
            }
            
            // æ›´æ–°åŠ‡æƒ…æ–‡æœ¬
            storyText.innerHTML = `<p>${gameState.story}</p>`;
            
            // æ›´æ–°äººç‰©è³‡æ–™
            if (gameState.characterData) {
                charName.textContent = gameState.characterData.å§“å || "æœªè¼‰å…¥";
                charAge.textContent = gameState.characterData.å¹´é½¡ || "æœªè¼‰å…¥";
                charPersonality.textContent = gameState.characterData.æ€§æ ¼ || "æœªè¼‰å…¥";
                charDescription.textContent = gameState.characterData.ç°¡ä»‹ || "æœªè¼‰å…¥";
            }
            
            // æ›´æ–°äººç‰©ç‹€æ…‹
            charFavor.textContent = gameState.characterStatus.favor;
            charMood.textContent = gameState.characterStatus.mood;
            charEnergy.textContent = gameState.characterStatus.energy;
            charSpirit.textContent = gameState.characterStatus.spirit;
            charThoughts.textContent = gameState.characterStatus.thoughts;
            
            // æ›´æ–°ç©å®¶è³‡æ–™
            playerName.value = gameState.playerData.name;
            playerSetting.value = gameState.playerData.setting;
            
            // æ›´æ–°äº‹ä»¶åˆ—è¡¨
            updateEventList();
        }

        // ç”Ÿæˆé¸é …
        function generateOptions() {
            optionsContainer.innerHTML = "";
            logDebug(`ç”Ÿæˆ ${gameState.options.length} å€‹é¸é …`);
            
            gameState.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = `${index + 1}. ${option}`;
                button.setAttribute('data-option', index);
                optionsContainer.appendChild(button);
                logDebug(`é¸é … ${index + 1}: ${option}`);
            });
        }

        // è™•ç†é¸é …é»æ“Š
        async function handleOptionClick(event) {
            if (!event.target.classList.contains('option-btn')) return;
            
            logDebug("é¸é …è¢«é»æ“Š");
            
            if (!gameState.apiConnected) {
                storyText.innerHTML = "<p>è«‹å…ˆè¨­å®šä¸¦æ¸¬è©¦APIé‡‘é‘°é€£æ¥ã€‚</p>";
                logDebug("APIæœªé€£æ¥ï¼Œç„¡æ³•è™•ç†é¸é …");
                return;
            }
            
            const optionIndex = parseInt(event.target.getAttribute('data-option'));
            const selectedOption = gameState.options[optionIndex];
            
            logDebug(`é¸æ“‡çš„é¸é …: ${selectedOption} (ç´¢å¼•: ${optionIndex})`);
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            storyText.innerHTML = "<p class='loading'>AIæ€è€ƒä¸­...</p>";
            
            try {
                // å‘¼å«APIç”ŸæˆåŠ‡æƒ…
                const prompt = createPrompt(selectedOption);
                logDebug(`ç”Ÿæˆæç¤ºè©ï¼Œé•·åº¦: ${prompt.length}`);
                
                const response = await callGeminiAPI(prompt, gameState.apiKey);
                
                if (response && response.candidates && response.candidates.length > 0) {
                    const text = response.candidates[0].content.parts[0].text;
                    logDebug(`APIå›æ‡‰ï¼Œé•·åº¦: ${text.length} å­—å…ƒ`);
                    
                    // è§£æAPIå›æ‡‰
                    const parsedResult = parseAPIResponse(text);
                    logDebug(`è§£æAPIå›æ‡‰ï¼ŒåŠ‡æƒ…é•·åº¦: ${parsedResult.story.length} å­—å…ƒ`);
                    
                    // æ›´æ–°éŠæˆ²ç‹€æ…‹
                    updateGameState(parsedResult, selectedOption);
                    
                    // æ›´æ–°é¡¯ç¤º
                    updateDisplay();
                    generateOptions();
                    
                    // æ·»åŠ äº‹ä»¶è¨˜éŒ„
                    addEvent(`é¸æ“‡: ${selectedOption}`, parsedResult.story.substring(0, 100) + "...");
                    
                    logDebug("é¸é …è™•ç†å®Œæˆ");
                } else {
                    throw new Error("APIæœªè¿”å›æœ‰æ•ˆå›æ‡‰");
                }
            } catch (error) {
                console.error("è™•ç†é¸é …æ™‚å‡ºéŒ¯:", error);
                storyText.innerHTML = `<p>éŒ¯èª¤: ${error.message}</p>`;
                logDebug(`è™•ç†é¸é …æ™‚å‡ºéŒ¯: ${error.message}`);
            }
        }

        // è™•ç†è‡ªå®šç¾©è¡Œå‹•
        async function handleCustomAction() {
            const action = customActionInput.value.trim();
            if (!action) {
                logDebug("è‡ªå®šç¾©è¡Œå‹•ç‚ºç©º");
                return;
            }
            
            logDebug(`è‡ªå®šç¾©è¡Œå‹•: ${action}`);
            
            if (!gameState.apiConnected) {
                storyText.innerHTML = "<p>è«‹å…ˆè¨­å®šä¸¦æ¸¬è©¦APIé‡‘é‘°é€£æ¥ã€‚</p>";
                logDebug("APIæœªé€£æ¥ï¼Œç„¡æ³•è™•ç†è‡ªå®šç¾©è¡Œå‹•");
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            storyText.innerHTML = "<p class='loading'>AIæ€è€ƒä¸­...</p>";
            
            try {
                // å‘¼å«APIç”ŸæˆåŠ‡æƒ…
                const prompt = createPrompt(action, true);
                logDebug(`ç”Ÿæˆè‡ªå®šç¾©è¡Œå‹•æç¤ºè©ï¼Œé•·åº¦: ${prompt.length}`);
                
                const response = await callGeminiAPI(prompt, gameState.apiKey);
                
                if (response && response.candidates && response.candidates.length > 0) {
                    const text = response.candidates[0].content.parts[0].text;
                    logDebug(`APIå›æ‡‰ï¼Œé•·åº¦: ${text.length} å­—å…ƒ`);
                    
                    // è§£æAPIå›æ‡‰
                    const parsedResult = parseAPIResponse(text);
                    logDebug(`è§£æAPIå›æ‡‰ï¼ŒåŠ‡æƒ…é•·åº¦: ${parsedResult.story.length} å­—å…ƒ`);
                    
                    // æ›´æ–°éŠæˆ²ç‹€æ…‹
                    updateGameState(parsedResult, action);
                    
                    // æ›´æ–°é¡¯ç¤º
                    updateDisplay();
                    generateOptions();
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    customActionInput.value = "";
                    
                    // æ·»åŠ äº‹ä»¶è¨˜éŒ„
                    addEvent(`è‡ªå®šç¾©è¡Œå‹•: ${action}`, parsedResult.story.substring(0, 100) + "...");
                    
                    logDebug("è‡ªå®šç¾©è¡Œå‹•è™•ç†å®Œæˆ");
                } else {
                    throw new Error("APIæœªè¿”å›æœ‰æ•ˆå›æ‡‰");
                }
            } catch (error) {
                console.error("è™•ç†è‡ªå®šç¾©è¡Œå‹•æ™‚å‡ºéŒ¯:", error);
                storyText.innerHTML = `<p>éŒ¯èª¤: ${error.message}</p>`;
                logDebug(`è™•ç†è‡ªå®šç¾©è¡Œå‹•æ™‚å‡ºéŒ¯: ${error.message}`);
            }
        }

        // å‰µå»ºAPIæç¤ºè©
        function createPrompt(action, isCustom = false) {
            const characterInfo = gameState.characterData ? 
                `äººç‰©: ${gameState.characterData.å§“å || "æœªçŸ¥"}, å¹´é½¡: ${gameState.characterData.å¹´é½¡ || "æœªçŸ¥"}, æ€§æ ¼: ${gameState.characterData.æ€§æ ¼ || "æœªçŸ¥"}` : 
                "äººç‰©: æœªå®šç¾©";
                
            const statusInfo = `å¥½æ„Ÿåº¦: ${gameState.characterStatus.favor}, å¿ƒæƒ…: ${gameState.characterStatus.mood}, é«”åŠ›: ${gameState.characterStatus.energy}, ç²¾ç¥: ${gameState.characterStatus.spirit}`;
            
            const locationInfo = `æ™‚é–“: ${gameState.date.year}å¹´${gameState.date.month}æœˆ${gameState.date.day}æ—¥, å¤©æ°£: ${gameState.weather}, åœ°é»: ${gameState.location}`;
            
            const prompt = `ä½ æ˜¯ä¸€å€‹æ–‡å­—éŠæˆ²AIï¼Œè² è²¬ç”ŸæˆéŠæˆ²åŠ‡æƒ…å’Œå›æ‡‰ã€‚
            
            ç•¶å‰éŠæˆ²ç‹€æ…‹:
            ${locationInfo}
            ${characterInfo}
            äººç‰©ç‹€æ…‹: ${statusInfo}
            ç©å®¶é¸æ“‡: ${action}
            
            è«‹ç”ŸæˆéŠæˆ²åŠ‡æƒ…å’Œæ›´æ–°éŠæˆ²ç‹€æ…‹ã€‚è«‹ä»¥ä»¥ä¸‹æ ¼å¼å›æ‡‰:
            
            åŠ‡æƒ…: [ç”Ÿæˆçš„åŠ‡æƒ…æ–‡æœ¬ï¼Œ200-300å­—]
            é¸é …1: [é¸é …æ–‡æœ¬]
            é¸é …2: [é¸é …æ–‡æœ¬]
            é¸é …3: [é¸é …æ–‡æœ¬]
            é¸é …4: [é¸é …æ–‡æœ¬]
            æ›´æ–°æ—¥æœŸ: [YYYY-MM-DD æˆ– ä¿æŒä¸è®Š]
            æ›´æ–°å¤©æ°£: [æ–°å¤©æ°£ æˆ– ä¿æŒä¸è®Š]
            æ›´æ–°åœ°é»: [æ–°åœ°é» æˆ– ä¿æŒä¸è®Š]
            æ›´æ–°äººç‰©ç‹€æ…‹: [æ–°ç‹€æ…‹ æˆ– ä¿æŒä¸è®Š]
            æ›´æ–°å¥½æ„Ÿåº¦: [+/-æ•¸å€¼ æˆ– ä¿æŒä¸è®Š]
            æ›´æ–°å¿ƒæƒ…: [æ–°å¿ƒæƒ… æˆ– ä¿æŒä¸è®Š]
            æ›´æ–°é«”åŠ›: [+/-æ•¸å€¼ æˆ– ä¿æŒä¸è®Š]
            æ›´æ–°ç²¾ç¥: [+/-æ•¸å€¼ æˆ– ä¿æŒä¸è®Š]
            æ›´æ–°å…§å¿ƒæƒ³æ³•: [æ–°çš„å…§å¿ƒæƒ³æ³•]`;
            
            return prompt;
        }

        // è§£æAPIå›æ‡‰
        function parseAPIResponse(text) {
            logDebug(`é–‹å§‹è§£æAPIå›æ‡‰ï¼Œæ–‡æœ¬é•·åº¦: ${text.length}`);
            
            const result = {
                story: "",
                options: [],
                date: "ä¿æŒä¸è®Š",
                weather: "ä¿æŒä¸è®Š",
                location: "ä¿æŒä¸è®Š",
                characterCondition: "ä¿æŒä¸è®Š",
                favor: "ä¿æŒä¸è®Š",
                mood: "ä¿æŒä¸è®Š",
                energy: "ä¿æŒä¸è®Š",
                spirit: "ä¿æŒä¸è®Š",
                thoughts: ""
            };
            
            const lines = text.split('\n');
            logDebug(`APIå›æ‡‰è¡Œæ•¸: ${lines.length}`);
            
            let currentKey = "";
            
            lines.forEach(line => {
                if (line.startsWith("åŠ‡æƒ…:")) {
                    result.story = line.substring(3).trim();
                    currentKey = "story";
                    logDebug(`æ‰¾åˆ°åŠ‡æƒ…: ${result.story.substring(0, 50)}...`);
                } else if (line.startsWith("é¸é …1:")) {
                    result.options[0] = line.substring(4).trim();
                    logDebug(`é¸é …1: ${result.options[0]}`);
                } else if (line.startsWith("é¸é …2:")) {
                    result.options[1] = line.substring(4).trim();
                    logDebug(`é¸é …2: ${result.options[1]}`);
                } else if (line.startsWith("é¸é …3:")) {
                    result.options[2] = line.substring(4).trim();
                    logDebug(`é¸é …3: ${result.options[2]}`);
                } else if (line.startsWith("é¸é …4:")) {
                    result.options[3] = line.substring(4).trim();
                    logDebug(`é¸é …4: ${result.options[3]}`);
                } else if (line.startsWith("æ›´æ–°æ—¥æœŸ:")) {
                    result.date = line.substring(5).trim();
                    logDebug(`æ›´æ–°æ—¥æœŸ: ${result.date}`);
                } else if (line.startsWith("æ›´æ–°å¤©æ°£:")) {
                    result.weather = line.substring(5).trim();
                    logDebug(`æ›´æ–°å¤©æ°£: ${result.weather}`);
                } else if (line.startsWith("æ›´æ–°åœ°é»:")) {
                    result.location = line.substring(5).trim();
                    logDebug(`æ›´æ–°åœ°é»: ${result.location}`);
                } else if (line.startsWith("æ›´æ–°äººç‰©ç‹€æ…‹:")) {
                    result.characterCondition = line.substring(7).trim();
                    logDebug(`æ›´æ–°äººç‰©ç‹€æ…‹: ${result.characterCondition}`);
                } else if (line.startsWith("æ›´æ–°å¥½æ„Ÿåº¦:")) {
                    result.favor = line.substring(6).trim();
                    logDebug(`æ›´æ–°å¥½æ„Ÿåº¦: ${result.favor}`);
                } else if (line.startsWith("æ›´æ–°å¿ƒæƒ…:")) {
                    result.mood = line.substring(5).trim();
                    logDebug(`æ›´æ–°å¿ƒæƒ…: ${result.mood}`);
                } else if (line.startsWith("æ›´æ–°é«”åŠ›:")) {
                    result.energy = line.substring(5).trim();
                    logDebug(`æ›´æ–°é«”åŠ›: ${result.energy}`);
                } else if (line.startsWith("æ›´æ–°ç²¾ç¥:")) {
                    result.spirit = line.substring(5).trim();
                    logDebug(`æ›´æ–°ç²¾ç¥: ${result.spirit}`);
                } else if (line.startsWith("æ›´æ–°å…§å¿ƒæƒ³æ³•:")) {
                    result.thoughts = line.substring(7).trim();
                    logDebug(`æ›´æ–°å…§å¿ƒæƒ³æ³•: ${result.thoughts}`);
                } else if (currentKey === "story" && line.trim()) {
                    result.story += "\n" + line;
                }
            });
            
            return result;
        }

        // æ›´æ–°éŠæˆ²ç‹€æ…‹
        function updateGameState(parsedResult, action) {
            logDebug(`æ›´æ–°éŠæˆ²ç‹€æ…‹ï¼Œå‹•ä½œ: ${action}`);
            
            // æ›´æ–°åŠ‡æƒ…
            gameState.story = parsedResult.story;
            logDebug(`åŠ‡æƒ…æ›´æ–°ï¼Œé•·åº¦: ${gameState.story.length}`);
            
            // æ›´æ–°é¸é …
            gameState.options = parsedResult.options.filter(opt => opt && opt.trim() !== "");
            logDebug(`é¸é …æ›´æ–°ï¼Œæ•¸é‡: ${gameState.options.length}`);
            
            // æ›´æ–°æ—¥æœŸ
            if (parsedResult.date !== "ä¿æŒä¸è®Š") {
                // ç°¡å–®è™•ç†æ—¥æœŸæ›´æ–°ï¼Œå¯¦éš›å¯æ›´è¤‡é›œ
                gameState.date.day += 1;
                if (gameState.date.day > 30) {
                    gameState.date.day = 1;
                    gameState.date.month += 1;
                    if (gameState.date.month > 12) {
                        gameState.date.month = 1;
                        gameState.date.year += 1;
                    }
                }
                logDebug(`æ—¥æœŸæ›´æ–°ç‚º: ${gameState.date.year}å¹´${gameState.date.month}æœˆ${gameState.date.day}æ—¥`);
            }
            
            // æ›´æ–°å¤©æ°£
            if (parsedResult.weather !== "ä¿æŒä¸è®Š") {
                gameState.weather = parsedResult.weather;
                logDebug(`å¤©æ°£æ›´æ–°ç‚º: ${gameState.weather}`);
            }
            
            // æ›´æ–°åœ°é»
            if (parsedResult.location !== "ä¿æŒä¸è®Š") {
                gameState.location = parsedResult.location;
                logDebug(`åœ°é»æ›´æ–°ç‚º: ${gameState.location}`);
            }
            
            // æ›´æ–°äººç‰©ç‹€æ…‹
            if (parsedResult.characterCondition !== "ä¿æŒä¸è®Š") {
                gameState.characterCondition = parsedResult.characterCondition;
                logDebug(`äººç‰©ç‹€æ…‹æ›´æ–°ç‚º: ${gameState.characterCondition}`);
            }
            
            // æ›´æ–°å¥½æ„Ÿåº¦
            if (parsedResult.favor !== "ä¿æŒä¸è®Š") {
                if (parsedResult.favor.startsWith("+")) {
                    gameState.characterStatus.favor += parseInt(parsedResult.favor.substring(1));
                    logDebug(`å¥½æ„Ÿåº¦å¢åŠ : ${parsedResult.favor.substring(1)}`);
                } else if (parsedResult.favor.startsWith("-")) {
                    gameState.characterStatus.favor -= parseInt(parsedResult.favor.substring(1));
                    logDebug(`å¥½æ„Ÿåº¦æ¸›å°‘: ${parsedResult.favor.substring(1)}`);
                } else {
                    gameState.characterStatus.favor = parseInt(parsedResult.favor);
                    logDebug(`å¥½æ„Ÿåº¦è¨­å®šç‚º: ${gameState.characterStatus.favor}`);
                }
                // é™åˆ¶ç¯„åœ
                gameState.characterStatus.favor = Math.max(0, Math.min(100, gameState.characterStatus.favor));
                logDebug(`å¥½æ„Ÿåº¦æœ€çµ‚å€¼: ${gameState.characterStatus.favor}`);
            }
            
            // æ›´æ–°å¿ƒæƒ…
            if (parsedResult.mood !== "ä¿æŒä¸è®Š") {
                gameState.characterStatus.mood = parsedResult.mood;
                logDebug(`å¿ƒæƒ…æ›´æ–°ç‚º: ${gameState.characterStatus.mood}`);
            }
            
            // æ›´æ–°é«”åŠ›
            if (parsedResult.energy !== "ä¿æŒä¸è®Š") {
                if (parsedResult.energy.startsWith("+")) {
                    gameState.characterStatus.energy += parseInt(parsedResult.energy.substring(1));
                    logDebug(`é«”åŠ›å¢åŠ : ${parsedResult.energy.substring(1)}`);
                } else if (parsedResult.energy.startsWith("-")) {
                    gameState.characterStatus.energy -= parseInt(parsedResult.energy.substring(1));
                    logDebug(`é«”åŠ›æ¸›å°‘: ${parsedResult.energy.substring(1)}`);
                } else {
                    gameState.characterStatus.energy = parseInt(parsedResult.energy);
                    logDebug(`é«”åŠ›è¨­å®šç‚º: ${gameState.characterStatus.energy}`);
                }
                // é™åˆ¶ç¯„åœ
                gameState.characterStatus.energy = Math.max(0, Math.min(100, gameState.characterStatus.energy));
                logDebug(`é«”åŠ›æœ€çµ‚å€¼: ${gameState.characterStatus.energy}`);
            }
            
            // æ›´æ–°ç²¾ç¥
            if (parsedResult.spirit !== "ä¿æŒä¸è®Š") {
                if (parsedResult.spirit.startsWith("+")) {
                    gameState.characterStatus.spirit += parseInt(parsedResult.spirit.substring(1));
                    logDebug(`ç²¾ç¥å¢åŠ : ${parsedResult.spirit.substring(1)}`);
                } else if (parsedResult.spirit.startsWith("-")) {
                    gameState.characterStatus.spirit -= parseInt(parsedResult.spirit.substring(1));
                    logDebug(`ç²¾ç¥æ¸›å°‘: ${parsedResult.spirit.substring(1)}`);
                } else {
                    gameState.characterStatus.spirit = parseInt(parsedResult.spirit);
                    logDebug(`ç²¾ç¥è¨­å®šç‚º: ${gameState.characterStatus.spirit}`);
                }
                // é™åˆ¶ç¯„åœ
                gameState.characterStatus.spirit = Math.max(0, Math.min(100, gameState.characterStatus.spirit));
                logDebug(`ç²¾ç¥æœ€çµ‚å€¼: ${gameState.characterStatus.spirit}`);
            }
            
            // æ›´æ–°å…§å¿ƒæƒ³æ³•
            if (parsedResult.thoughts) {
                gameState.characterStatus.thoughts = parsedResult.thoughts;
                logDebug(`å…§å¿ƒæƒ³æ³•æ›´æ–°ç‚º: ${gameState.characterStatus.thoughts.substring(0, 50)}...`);
            }
            
            // éš¨æ©Ÿåˆ‡æ›èƒŒæ™¯å’Œç«‹ç¹ª
            if (gameState.backgroundImages.length > 0) {
                const randomBgIndex = Math.floor(Math.random() * gameState.backgroundImages.length);
                gameState.currentBackground = gameState.backgroundImages[randomBgIndex].url;
                logDebug(`éš¨æ©Ÿåˆ‡æ›èƒŒæ™¯: ${gameState.backgroundImages[randomBgIndex].name}`);
            }
            
            if (gameState.characterImages.length > 0) {
                const randomCharIndex = Math.floor(Math.random() * gameState.characterImages.length);
                gameState.currentCharacterImage = gameState.characterImages[randomCharIndex].url;
                logDebug(`éš¨æ©Ÿåˆ‡æ›ç«‹ç¹ª: ${gameState.characterImages[randomCharIndex].name}`);
            }
        }

        // å„²å­˜ç©å®¶è³‡æ–™
        function savePlayerData() {
            gameState.playerData.name = playerName.value;
            gameState.playerData.setting = playerSetting.value;
            
            logDebug(`å„²å­˜ç©å®¶è³‡æ–™: åç¨±=${gameState.playerData.name}, è¨­å®šé•·åº¦=${gameState.playerData.setting.length}`);
            
            alert("ç©å®¶è³‡æ–™å·²å„²å­˜");
            
            // æ·»åŠ äº‹ä»¶è¨˜éŒ„
            addEvent("æ›´æ–°ç©å®¶è³‡æ–™", `ç©å®¶åç¨±: ${gameState.playerData.name}`);
        }

        // å„²å­˜éŠæˆ²
        function saveGame() {
            logDebug("é–‹å§‹å„²å­˜éŠæˆ²");
            
            // å‰µå»ºå­˜æª”æ•¸æ“š
            const saveData = JSON.stringify(gameState, null, 2);
            logDebug(`å­˜æª”æ•¸æ“šå¤§å°: ${saveData.length} å­—å…ƒ`);
            
            // å‰µå»ºä¸‹è¼‰é€£çµ
            const blob = new Blob([saveData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // å‰µå»ºä¸‹è¼‰é€£çµå…ƒç´ 
            const a = document.createElement('a');
            a.href = url;
            a.download = `AIæ–‡å­—éŠæˆ²_å­˜æª”_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // é‡‹æ”¾URLå°è±¡
            URL.revokeObjectURL(url);
            
            // é¡¯ç¤ºç‹€æ…‹
            showStatus(saveStatus, "éŠæˆ²å·²å„²å­˜", "success");
            setTimeout(() => {
                saveStatus.classList.add('hidden');
            }, 3000);
            
            // æ·»åŠ äº‹ä»¶è¨˜éŒ„
            addEvent("å„²å­˜éŠæˆ²", "éŠæˆ²é€²åº¦å·²å„²å­˜è‡³æœ¬åœ°æª”æ¡ˆ");
            
            logDebug("éŠæˆ²å„²å­˜å®Œæˆ");
        }

        // æ·»åŠ äº‹ä»¶è¨˜éŒ„
        function addEvent(title, content) {
            const now = new Date();
            const timestamp = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            gameState.events.unshift({
                title: title,
                content: content,
                timestamp: timestamp
            });
            
            logDebug(`æ·»åŠ äº‹ä»¶: ${title}`);
            
            updateEventList();
        }

        // æ›´æ–°äº‹ä»¶åˆ—è¡¨
        function updateEventList() {
            eventList.innerHTML = "";
            
            gameState.events.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                eventItem.innerHTML = `
                    <div class="event-title">${event.title} <small>(${event.timestamp})</small></div>
                    <p>${event.content}</p>
                `;
                eventList.appendChild(eventItem);
            });
            
            logDebug(`æ›´æ–°äº‹ä»¶åˆ—è¡¨ï¼Œå…± ${gameState.events.length} å€‹äº‹ä»¶`);
        }

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status-indicator ${type}`;
            element.classList.remove('hidden');
            logDebug(`ç‹€æ…‹è¨Šæ¯: ${message} (${type})`);
        }

        // èª¿è©¦æ—¥èªŒ
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}<br>`;
            debugLog.innerHTML = logEntry + debugLog.innerHTML;
            
            // é™åˆ¶æ—¥èªŒé•·åº¦
            if (debugLog.children.length > 50) {
                debugLog.innerHTML = debugLog.innerHTML.substring(0, 5000);
            }
            
            console.log(`[AIéŠæˆ²èª¿è©¦] ${message}`);
        }

        // åˆ‡æ›èª¿è©¦é¢æ¿
        function toggleDebug() {
            if (debugContent.style.display === 'none') {
                debugContent.style.display = 'block';
                logDebug("èª¿è©¦é¢æ¿å±•é–‹");
            } else {
                debugContent.style.display = 'none';
                logDebug("èª¿è©¦é¢æ¿æ”¶èµ·");
            }
        }

        // åˆå§‹åŒ–éŠæˆ²
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
